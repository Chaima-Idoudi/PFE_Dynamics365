<div class="chat-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="search-box">
      <div class="search-container">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z" stroke="#9E9E9E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M21 21L16.65 16.65" stroke="#9E9E9E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <input [(ngModel)]="searchTerm" placeholder="Search contacts...">
      </div>
    </div>
    <div class="contacts-list">
      <!-- First render the self-contact -->
      <ng-container *ngFor="let contact of filteredContacts">
        <div *ngIf="contact.userId === authService.getUserId()"
             class="contact-item self-contact" 
             [class.active]="selectedContact?.userId === contact.userId"
             (click)="selectContact(contact)">
          <app-avatar 
            [imageUrl]="contact.photo" 
            [name]="contact.fullName"
            [size]="40"
            [borderColor]="'#0078d4'">
          </app-avatar>
          
          <div class="contact-info">
            <span class="name">{{contact.fullName}}</span>
            <span class="status">
              Vous-mÃªme
            </span>
          </div>
        </div>
      </ng-container>
      
      <!-- Then render all other contacts -->
      <ng-container *ngFor="let contact of filteredContacts">
        <div *ngIf="contact.userId !== authService.getUserId()"
             class="contact-item" 
             [class.active]="selectedContact?.userId === contact.userId"
             (click)="selectContact(contact)">
          <app-avatar 
            [imageUrl]="contact.photo" 
            [name]="contact.fullName"
            [size]="40"
            [borderColor]="contact.isConnected ? '#4caf50' : 'rgba(0, 32, 80, 0.1)'">
          </app-avatar>
          
          <div class="contact-info">
            <span class="name">{{contact.fullName}}</span>
            <span class="status" [class.online]="contact.isConnected">
              {{contact.isConnected ? 'Online' : 'Offline'}}
            </span>
          </div>
          <span *ngIf="contact.unreadCount > 0" class="badge">
            {{contact.unreadCount}}
          </span>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Chat Area -->
  <div class="chat-area" *ngIf="selectedContact; else noContact">
    <div class="chat-header">
      <app-avatar 
        [imageUrl]="selectedContact.photo" 
        [name]="selectedContact.fullName"
        [size]="40"
        [borderColor]="selectedContact.isConnected ? '#4caf50' : 'rgba(0, 32, 80, 0.1)'">
      </app-avatar>
      <div class="contact-details">
        <h3>{{selectedContact.fullName}}</h3>
        <span class="status" [class.online]="selectedContact.isConnected">
          {{selectedContact.isConnected ? 'Online' : 'Offline'}}
        </span>
      </div>
    </div>

    <div class="messages" #messagesContainer>
      <div *ngIf="isLoading" class="loading">
        <div class="flex flex-col items-center justify-center py-12">
          <fa-icon [icon]="icons.spinner" class="text-[#03A5ED] text-3xl animate-spin mb-4"></fa-icon>
          <p class="text-gray-500 text-sm">Loading messages...</p>
        </div>
      </div>
      
      <!-- Empty state -->
      <div *ngIf="!isLoading && isEmptyConversation" class="empty-conversation">
        <div class="empty-state-content">
          <div class="empty-icon">ðŸ’¬</div>
          <h3>No messages yet</h3>
          <p>Start the conversation with {{selectedContact.fullName}}</p>
          <p class="hint">Send your first message to begin chatting</p>
        </div>
      </div>
      
      <!-- Messages list -->
      <div *ngIf="!isLoading && !isEmptyConversation">
        <div *ngFor="let message of messages" 
             class="message" 
             [class.sent]="message.isMe" 
             [class.received]="!message.isMe"
             [class.sending]="message.status === 'sending'"
             [class.failed]="message.status === 'failed'">
          <div class="content">{{message.message}}</div>
          
          <!-- File attachment display -->
          <div *ngIf="message.hasAttachment" class="attachment-container">
            <!-- Image attachment -->
            <div *ngIf="message.attachmentType === '1'" class="image-attachment">
              <img *ngIf="!message.id.startsWith('temp-')" 
                  [src]="getAttachmentUrl(message)" 
                  [alt]="message.attachmentName"
                  (click)="openImagePreview(message)"
                  (load)="onImageLoaded()"
                  (error)="onImageError(message)">
              <div *ngIf="message.id.startsWith('temp-')" class="image-placeholder">
                <div class="loading-spinner">
                  <fa-icon [icon]="icons.spinner" class="animate-spin"></fa-icon>
                </div>
                <span>Uploading image...</span>
              </div>
            </div>
            
            <!-- Document attachment -->
            <div *ngIf="message.attachmentType === '2'" class="document-attachment">
              <div class="document-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M14 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M16 13H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M16 17H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M10 9H9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <div class="document-info">
                <span class="document-name">{{message.attachmentName}}</span>
                <span class="document-size">{{formatFileSize(message.attachmentSize || 0)}}</span>
              </div>
              <a [href]="getAttachmentUrl(message)" 
                 download="{{message.attachmentName}}" 
                 class="download-button">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </a>
            </div>
            
            <!-- Other file types -->
            <div *ngIf="message.attachmentType === '3'" class="document-attachment">
              <div class="file-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M13 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V9L13 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M13 2V9H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <div class="file-info">
                <span class="file-name">{{message.attachmentName}}</span>
                <span class="file-size">{{formatFileSize(message.attachmentSize || 0)}}</span>
              </div>
              <a [href]="getAttachmentUrl(message)" 
                 download="{{message.attachmentName}}" 
                 class="download-button">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </a>
            </div>
          </div>
          
          <div class="time">
            {{message.timestamp | date:'shortTime'}}
            <span *ngIf="message.isMe" class="read-status">
              <ng-container *ngIf="message.status === 'sending'">Sending...</ng-container>
              <ng-container *ngIf="message.status === 'sent'">{{message.isRead ? 'âœ“âœ“' : 'âœ“'}}</ng-container>
              <ng-container *ngIf="message.status === 'failed'">
                Failed <button class="retry-btn" (click)="retryMessage(message.id)">Retry</button>
              </ng-container>
              <ng-container *ngIf="!message.status">{{message.isRead ? 'âœ“âœ“' : 'âœ“'}}</ng-container>
            </span>
          </div>
        </div>
      </div>
      
      <!-- Typing indicator -->
      <div *ngIf="isSelectedContactTyping" class="typing-indicator">
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <span>{{selectedContact.fullName}} is typing...</span>
      </div>
    </div>

    <!-- Message input with file attachment button -->
    <div class="message-input">
      <div class="attachment-button" (click)="fileInput.click()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21.44 11.05L12.25 20.24C11.1242 21.3658 9.59723 21.9983 8.005 21.9983C6.41277 21.9983 4.88584 21.3658 3.76 20.24C2.63416 19.1142 2.00166 17.5872 2.00166 15.995C2.00166 14.4028 2.63416 12.8758 3.76 11.75L12.33 3.18C13.0806 2.42925 14.0991 2.00049 15.16 2.00049C16.2209 2.00049 17.2394 2.42925 17.99 3.18C18.7406 3.93075 19.1693 4.94924 19.1693 6.01C19.1693 7.07076 18.7406 8.08925 17.99 8.84L9.41 17.41C9.03472 17.7853 8.52573 17.9936 7.995 17.9936C7.46427 17.9936 6.95528 17.7853 6.58 17.41C6.20472 17.0347 5.99646 16.5257 5.99646 15.995C5.99646 15.4643 6.20472 14.9553 6.58 14.58L15.07 6.1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <input #fileInput type="file" style="display: none" (change)="onFileSelected($event)" accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/plain">
      
      <textarea [(ngModel)]="newMessage" 
                placeholder="Type your message..." 
                (keydown.enter)="$event.preventDefault(); sendMessage()"
                (input)="onTyping()"></textarea>
      
      <button (click)="sendMessage()" [disabled]="!newMessage.trim() && !selectedFile">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
           </svg>
      </button>
    </div>
    
    <!-- File preview before sending -->
    <div *ngIf="selectedFile" class="file-preview">
      <div class="file-preview-header">
        <span>Selected File</span>
        <button class="close-button" (click)="clearSelectedFile()">Ã—</button>
      </div>
      <div class="file-preview-content">
        <!-- Image preview -->
        <img *ngIf="isImageFile(selectedFile)" [src]="selectedFilePreview" alt="Image preview">
        
        <!-- Document/file preview -->
        <div *ngIf="!isImageFile(selectedFile)" class="file-info-preview">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div>
            <div class="file-name-preview">{{selectedFile.name}}</div>
            <div class="file-size-preview">{{formatFileSize(selectedFile.size)}}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- No contact selected state -->
  <ng-template #noContact>
    <div class="no-contact-selected">
      <div class="empty-state">
        <div class="empty-icon">ðŸ‘‹</div>
        <h3>Select a contact to start chatting</h3>
        <p>Choose someone from your contacts list to begin your conversation</p>
      </div>
    </div>
  </ng-template>
</div>

<!-- Image preview modal -->
<div *ngIf="previewImage" class="image-preview-modal" (click)="closeImagePreview()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <span class="image-name">{{previewImage.attachmentName}}</span>
      <button class="close-button" (click)="closeImagePreview()">Ã—</button>
    </div>
    <div class="modal-body">
      <img [src]="getAttachmentUrl(previewImage)" [alt]="previewImage.attachmentName">
    </div>
    <div class="modal-footer">
      <a [href]="getAttachmentUrl(previewImage)" 
         download="{{previewImage.attachmentName}}" 
         class="download-button">
        Download
      </a>
    </div>
  </div>
</div>